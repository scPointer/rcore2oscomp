
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>通过 Manual Page 添加 Syscall · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-katex/katex.min.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-alerts/style.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-emphasize/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-codeblock-label/block.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-click-reveal/click_reveal.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-expandable-chapters-interactive/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-intopic-toc/style.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../../styles/website.css">
        
    
        
    
        
    
        
    
        
    
        
    


    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="tid.html" />
    
    
    <link rel="prev" href="gdb.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    实验简介
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Lab 1</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../lab1/intro.html">
            
                <a href="../lab1/intro.html">
            
                    
                    实验概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../lab1/toelf.html">
            
                <a href="../lab1/toelf.html">
            
                    
                    编译到二进制代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../lab1/clib.html">
            
                <a href="../lab1/clib.html">
            
                    
                    测例库介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../lab1/tofs.html">
            
                <a href="../lab1/tofs.html">
            
                    
                    打包进文件系统
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../lab1/boot.html">
            
                <a href="../lab1/boot.html">
            
                    
                    扩展阅读：RISC-V 架构与内核启动
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="../lab1/exercise.html">
            
                <a href="../lab1/exercise.html">
            
                    
                    练习
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Lab 2</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="intro.html">
            
                <a href="intro.html">
            
                    
                    实验概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="pos.html">
            
                <a href="pos.html">
            
                    
                    三种调试方法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="usecode.html">
            
                <a href="usecode.html">
            
                    
                    引入外部代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="gdb.html">
            
                <a href="gdb.html">
            
                    
                    GDB 调试
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="3.5" data-path="syscall.html">
            
                <a href="syscall.html">
            
                    
                    通过 Manual Page 添加 Syscall
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="tid.html">
            
                <a href="tid.html">
            
                    
                    规范：TID 定义问题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.7" data-path="exercise.html">
            
                <a href="exercise.html">
            
                    
                    练习
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Lab 3</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../lab3/intro.html">
            
                <a href="../lab3/intro.html">
            
                    
                    实验概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../lab3/before.html">
            
                <a href="../lab3/before.html">
            
                    
                    部分往届内核及运行指引
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../lab3/cache.html">
            
                <a href="../lab3/cache.html">
            
                    
                    探索 cargo 的缓存
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="../lab3/justrun.html">
            
                <a href="../lab3/justrun.html">
            
                    
                    如何使用往届内核
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="../lab3/ls.html">
            
                <a href="../lab3/ls.html">
            
                    
                    定位 ls 命令存在的问题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="../lab3/strace.html">
            
                <a href="../lab3/strace.html">
            
                    
                    strace 简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7" data-path="../lab3/lsdebug.html">
            
                <a href="../lab3/lsdebug.html">
            
                    
                    使用 strace 调试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.8" data-path="../lab3/exercise.html">
            
                <a href="../lab3/exercise.html">
            
                    
                    练习
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.9" data-path="../lab3/hint.html">
            
                <a href="../lab3/hint.html">
            
                    
                    实验提示
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Lab EX</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../labex/intro.html">
            
                <a href="../labex/intro.html">
            
                    
                    实验概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="../labex/modular.html">
            
                <a href="../labex/modular.html">
            
                    
                    操作系统与模块划分
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="../labex/module.html">
            
                <a href="../labex/module.html">
            
                    
                    对模块的要求
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="../labex/vfs.html">
            
                <a href="../labex/vfs.html">
            
                    
                    编写独立的模块
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="../labex/exercise.html">
            
                <a href="../labex/exercise.html">
            
                    
                    练习
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >通过 Manual Page 添加 Syscall</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="&#x901A;&#x8FC7;-manual-page-&#x6DFB;&#x52A0;-syscall">&#x901A;&#x8FC7; Manual Page &#x6DFB;&#x52A0; Syscall</h1>
<p>&#x52A0;&#x4E0A;&#x4E0A;&#x4E00;&#x7AE0;&#x91CC;&#x5BF9; <code>os/src/mm/memory_set.rs:MemorySet::from_elf()</code> &#x7684;&#x4FEE;&#x6539;&#xFF0C;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x518D;&#x6B21;&#x8FD0;&#x884C; <code>hellostd</code> &#x6D4B;&#x4F8B;&#x3002;</p>
<p>&#x4E0D;&#x51FA;&#x610F;&#x5916;&#x7684;&#x8BDD;&#xFF0C;&#x8F93;&#x51FA;&#x5E94;&#x8BE5;&#x662F;&#xFF08;&#x6839;&#x636E;&#x4F60;&#x539F;&#x4ED3;&#x5E93;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x62A5;&#x9519;&#x884C;&#x53F7;&#x53EF;&#x80FD;&#x7565;&#x6709;&#x4E0D;&#x540C;&#xFF09;&#xFF1A;</p>
<pre><code class="lang-bash">&gt;&gt; hellostd
[kernel] Panicked at src/syscall/mod.rs:168 Unsupported syscall_id: 96
</code></pre>
<p>&#x574F;&#x6D88;&#x606F;&#x662F;&#xFF0C;&#x5B83;&#x4ECD;&#x7136;&#x6CA1;&#x6709;&#x8FD0;&#x884C;&#x6210;&#x529F;&#xFF1B;&#x597D;&#x6D88;&#x606F;&#x662F;&#xFF0C;&#x8FD9;&#x5B9E;&#x9645;&#x4E0A;&#x5DF2;&#x7ECF;&#x662F;&#x6700;&#x540E;&#x4E00;&#x6B65;&#x4E86;&#xFF01;&#x53EA;&#x8981;&#x6211;&#x4EEC;&#x6309;&#x7167; <code>rCore-Tutorial</code> &#x90A3;&#x6837;&#x586B;&#x8865;&#x4E0A;&#x7F3A;&#x5931;&#x7684; <code>syscall</code>&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x6210;&#x529F;&#x8FD0;&#x884C;&#x8FD9;&#x4E2A;&#x6D4B;&#x4F8B;&#x3002;&#x4E0D;&#x8FC7;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x5C31;&#x4E0D;&#x662F;&#x6307;&#x5BFC;&#x4E66;&#x6765;&#x5B9A;&#x4E49;&#x8FD9;&#x4E9B; <code>syscall</code> &#x4E86;&#xFF0C;&#x800C;&#x662F;&#x9700;&#x8981;&#x67E5;&#x770B;&#x901A;&#x7528;&#x7684; <code>syscall</code> &#x6807;&#x51C6;&#x3002;</p>
<h3 id="syscall-&#x5B9A;&#x4E49;">Syscall &#x5B9A;&#x4E49;</h3>
<p>&#x901A;&#x5E38;&#x6765;&#x8BF4;&#xFF0C;<code>syscall</code> &#x5B9A;&#x4E49;&#x53EF;&#x4EE5;&#x5728; <code>man7.org</code> &#x67E5;&#x5230;&#xFF0C;&#x6BD4;&#x5982;<a href="https://man7.org/linux/man-pages/man2/clone.2.html" target="_blank">&#x8FD9;&#x662F;&#x4E00;&#x4E2A; <code>sys_clone</code> &#x7684;&#x5B9A;&#x4E49;</a>&#xFF0C;&#x91CC;&#x9762;&#x5305;&#x542B;&#x4E86;&#x4F60;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x77E5;&#x9053;&#x7684;&#x7EDD;&#x5927;&#x90E8;&#x5206;&#x4E1C;&#x897F;&#xFF0C;&#x5305;&#x62EC;</p>
<ul>
<li>&#x63A5;&#x53E3;&#x5B9A;&#x4E49;&#x548C;&#x53C2;&#x6570;&#x5217;&#x8868;<pre><code>int clone(int (*fn)(void *_Nullable), void *stack, int flags,
      void *_Nullable arg, ...  /* pid_t *_Nullable parent_tid,
                                  void *_Nullable tls,
                                  pid_t *_Nullable child_tid */ );
</code></pre></li>
<li>syscall &#x7684;&#x8BED;&#x4E49;&#x4EE5;&#x53CA;&#x5404;&#x4E2A;&#x53C2;&#x6570;&#x7684;&#x8BED;&#x4E49;&#x3002;&#x8FD9;&#x5305;&#x62EC;&#x5173;&#x4E8E; <code>syscall</code> &#x672C;&#x8EAB;&#x7684;&#x63CF;&#x8FF0;&#x548C;&#x5404;&#x4E2A;&#x53C2;&#x6570;&#x7684;&#x63CF;&#x8FF0;&#x3002;&#x5982;&#x679C;&#x53C2;&#x6570;&#x5305;&#x62EC;&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x8FD8;&#x4F1A;&#x63D0;&#x6BCF;&#x4E00;&#x4E2A;&#x6807;&#x5FD7;&#x4F4D;&#x7684;&#x542B;&#x4E49;&#x3002;&#x4E0D;&#x8FC7;&#x8FD9;&#x4E2A;&#x9875;&#x9762;&#x5E76;&#x4E0D;&#x4F1A;&#x544A;&#x8BC9;&#x4F60;&#x5728;&#x54EA;&#x4E00;&#x4E2A;&#x4F4D;&#x3002;&#x4E0B;&#x9762;&#x8282;&#x9009;&#x4E00;&#x4E9B; <code>sys_clone</code> &#x7684;&#x5B9A;&#x4E49;</li>
</ul>
<pre><code>DESCRIPTION
       These system calls create a new (&quot;child&quot;) process, in a manner
       similar to fork(2).

       By contrast with fork(2), these system calls provide more precise
       control over what pieces of execution context are shared between
       the calling process and the child process.
......
   The clone() wrapper function
       When the child process is created with the clone() wrapper
       function, it commences execution by calling the function pointed
       to by the argument fn.  (This differs from fork(2), where
       execution continues in the child from the point of the fork(2)
       call.)  The arg argument is passed as the argument of the
       function fn.
    clone3()
......
   Equivalence between clone() and clone3() arguments
......
   The flags mask
       CLONE_CHILD_CLEARTID (since Linux 2.5.49)
              Clear (zero) the child thread ID at the location pointed
              to by child_tid (clone()) or cl_args.child_tid (clone3())
              in child memory when the child exits, and do a wakeup on
              the futex at that address.  The address involved may be
              changed by the set_tid_address(2) system call.  This is
              used by threading libraries.

       CLONE_CHILD_SETTID (since Linux 2.5.49)
......
       CLONE_CLEAR_SIGHAND (since Linux 5.5)
......
</code></pre><ul>
<li>&#x8FD4;&#x56DE;&#x503C;</li>
<li>&#x9519;&#x8BEF;&#x7C7B;&#x578B;&#x3002;&#x5728; <code>rCore-Tutorial</code> &#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x4E00;&#x4E2A; <code>syscall</code> &#x6267;&#x884C;&#x5931;&#x8D25;&#xFF0C;&#x901A;&#x5E38;&#x662F;&#x76F4;&#x63A5;&#x8FD4;&#x56DE; <code>-1</code> &#x7684;&#x3002;&#x4F46;&#x5728; <code>POSIX syscall</code> &#x4E2D;&#xFF0C;<code>syscall</code> &#x53EF;&#x4EE5;&#x8FD4;&#x56DE;&#x4E0D;&#x540C;&#x7684;&#x8D1F;&#x6570;&#xFF0C;&#x4EE3;&#x8868;&#x4E0D;&#x540C;&#x7684;&#x9519;&#x8BEF;&#x7C7B;&#x578B;&#x3002;&#x4E00;&#x4E9B;&#x6807;&#x51C6;&#x5E93;&#x7A0B;&#x5E8F;&#x4F1A;&#x901A;&#x8FC7;&#x5224;&#x65AD;&#x4E0D;&#x540C;&#x7684;&#x9519;&#x8BEF;&#x7C7B;&#x578B;&#x6765;&#x6267;&#x884C;&#x4E0D;&#x540C;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x6240;&#x4EE5; debug &#x65F6;&#x522B;&#x5FD8;&#x4E86;&#x4F60;&#x7ED9;&#x7528;&#x6237;&#x7A0B;&#x5E8F;&#x8FD4;&#x56DE;&#x7684;&#x9519;&#x8BEF;&#x7C7B;&#x578B;&#x4E5F;&#x53EF;&#x80FD;&#x51FA;&#x9519;&#x3002;</li>
<li>&#x5176;&#x4ED6;&#x9700;&#x8981;&#x8BF4;&#x660E;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x6BD4;&#x5982;&#x5B58;&#x5728;&#x7684;&#x7248;&#x672C;&#x51B2;&#x7A81;&#x3001;&#x5386;&#x53F2;&#x7248;&#x672C;&#x95EE;&#x9898;&#x3001;&#x989D;&#x5916;&#x7684;&#x8BF4;&#x660E;&#x3001;&#x4EE3;&#x7801;&#x793A;&#x4F8B;&#x7B49;&#x7B49;</li>
<li>&#x4E00;&#x4E9B;&#x94FE;&#x63A5;&#xFF0C;&#x53EF;&#x4EE5;&#x70B9;&#x5230;&#x76F8;&#x5173;&#x7684;&#x5176;&#x4ED6; <code>syscall</code></li>
</ul>
<h3 id="&#x5982;&#x4F55;&#x641C;&#x7D22;&#x5230;syscall&#x5B9A;&#x4E49;">&#x5982;&#x4F55;&#x641C;&#x7D22;&#x5230;Syscall&#x5B9A;&#x4E49;</h3>
<p>&#x4E00;&#x822C;&#x6765;&#x8BF4;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x77E5;&#x9053; <code>syscall</code> &#x7684;&#x540D;&#x5B57;&#x3002;&#x603B;&#x662F;&#x53EF;&#x4EE5;&#x7528;&#x641C;&#x7D22;&#x5F15;&#x64CE;&#x627E;&#x5230;&#x4E0A;&#x9762;&#x7684;&#x9875;&#x9762;&#x7684;&#x3002;</p>
<p>&#x4F46;&#x6211;&#x4EEC;&#x73B0;&#x5728;&#x53EA;&#x77E5;&#x9053; <code>syscall</code> &#x7684; ID &#x662F; <code>96</code>&#xFF0C;&#x600E;&#x4E48;&#x77E5;&#x9053;&#x5B83;&#x662F;&#x8C01;&#x5462;&#xFF1F;</p>
<ul>
<li>&#x53EF;&#x4EE5;&#x7528;&#x7F51;&#x4E0A;&#x6574;&#x7406;&#x597D;&#x7684;&#x535A;&#x5BA2;&#xFF0C;&#x6BD4;&#x5982;<a href="https://jborza.com/post/2021-05-11-riscv-linux-syscalls/" target="_blank">&#x8FD9;&#x4E00;&#x7BC7;</a>&#xFF0C;&#x5728;&#x7F51;&#x9875;&#x91CC;&#x641C;&#x7D22; <code>96</code> &#x5C31;&#x80FD;&#x627E;&#x5230;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x7684; <code>sys_set_tid_address</code>&#x3002;</li>
<li>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6E90;&#x4EE3;&#x7801;&#x67E5;&#x8BE2;&#x3002;&#x4F8B;&#x5982;&#x6211;&#x4EEC;&#x5728;<a href="../lab1/intro.html#&#x5B9E;&#x9A8C;&#x51C6;&#x5907;">&#x6700;&#x521D;&#x7684;&#x5B9E;&#x9A8C;</a> &#x4E2D;&#x4E0B;&#x8F7D;&#x7684;&#x4EA4;&#x53C9;&#x7F16;&#x8BD1;&#x5DE5;&#x5177;&#x94FE;&#x4F7F;&#x7528;&#x7684; <code>musl-libc</code>&#x3002;&#x53EF;&#x4EE5;&#x5728;<a href="https://git.musl-libc.org/cgit/musl" target="_blank">&#x8FD9;&#x91CC;</a> &#x4E0B;&#x8F7D;&#x5230; <code>musl</code> &#x5E93;&#x7684;&#x6E90;&#x4EE3;&#x7801;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x76EE;&#x5F55;&#x4E0B;&#x7684; <code>arch/riscv64/bits/syscall.h.in</code> &#x4E2D;&#x627E;&#x5230; <code>syscall</code> &#x5BF9;&#x5E94;&#x7684;&#x540D;&#x5B57;&#x3002;</li>
</ul>
<h3 id="&#x56DE;&#x5230;&#x4E3B;&#x7EBF;">&#x56DE;&#x5230;&#x4E3B;&#x7EBF;</h3>
<p>&#x81F3;&#x5C11;&#x5728;&#x53C2;&#x52A0;&#x6BD4;&#x8D5B;&#x8FD9;&#x4E2A;&#x9636;&#x6BB5;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x8981;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A; <code>syscall</code> &#x65F6;<strong>&#x4E0D;&#x9700;&#x8981;</strong>&#x5B9E;&#x73B0;&#x5B9A;&#x4E49;&#x91CC;&#x7684;&#x6240;&#x6709;&#x5185;&#x5BB9;&#x3002;&#x5B9A;&#x4E49;&#x4E2D; 90% &#x7684;&#x90E8;&#x5206;&#x53EF;&#x80FD;&#x53EA;&#x4F1A;&#x6709;&#x4E0D;&#x5230; 1% &#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4F1A;&#x4F7F;&#x7528;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x5E0C;&#x671B;&#x652F;&#x6301;&#x6700;&#x57FA;&#x672C;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x8BA9;&#x7528;&#x6237;&#x7A0B;&#x5E8F;&#x6210;&#x529F;&#x8FD0;&#x884C;&#x5C31;&#x884C;&#xFF0C;&#x66F4;&#x8BE6;&#x7EC6;&#x7684;&#x5B9A;&#x4E49;&#x53EF;&#x4EE5;&#x4EE5;&#x540E;&#x9700;&#x8981;&#x65F6;&#x518D;&#x52A0;&#x3002;</p>
<p>&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5B9E;&#x73B0; <code>96</code> &#x53F7; <code>syscall</code> <code>set_tid_address</code>&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x5728;<a href="https://man7.org/linux/man-pages/man2/set_tid_address.2.html" target="_blank">&#x8FD9;&#x91CC;</a>&#x627E;&#x5230;&#x5B83;&#x7684;&#x63CF;&#x8FF0;&#x3002;</p>
<p>&#x89C2;&#x5BDF;&#x4E00;&#x4E0B;&#x5B83;&#x7684;&#x63CF;&#x8FF0;&#xFF1A;</p>
<pre><code>SYNOPSIS

       #include &lt;sys/syscall.h&gt;      /* Definition of SYS_* constants */
       #include &lt;unistd.h&gt;

       pid_t syscall(SYS_set_tid_address, int *tidptr);

       Note: glibc provides no wrapper for set_tid_address(),
       necessitating the use of syscall(2).

DESCRIPTION

       For each thread, the kernel maintains two attributes (addresses)
       called set_child_tid and clear_child_tid.  These two attributes
       contain the value NULL by default.

       set_child_tid
              If a thread is started using clone(2) with the
              CLONE_CHILD_SETTID flag, set_child_tid is set to the value
              passed in the ctid argument of that system call.

              When set_child_tid is set, the very first thing the new
              thread does is to write its thread ID at this address.

       clear_child_tid
              If a thread is started using clone(2) with the
              CLONE_CHILD_CLEARTID flag, clear_child_tid is set to the
              value passed in the ctid argument of that system call.

       The system call set_tid_address() sets the clear_child_tid value
       for the calling thread to tidptr.

       When a thread whose clear_child_tid is not NULL terminates, then,
       if the thread is sharing memory with other threads, then 0 is
       written at the address specified in clear_child_tid and the
       kernel performs the following operation:

           futex(clear_child_tid, FUTEX_WAKE, 1, NULL, NULL, 0);

       The effect of this operation is to wake a single thread that is
       performing a futex wait on the memory location.  Errors from the
       futex wake operation are ignored.
RETURN VALUE

       set_tid_address() always returns the caller&apos;s thread ID.

ERRORS

       set_tid_address() always succeeds.
</code></pre><p>&#x4F1A;&#x53D1;&#x73B0;&#x8FD9;&#x4E2A; <code>set_child_tid</code> &#x548C; <code>clear_child_tid</code> &#x7684;&#x63CF;&#x8FF0;&#x90FD;&#x662F;&#x7528; <code>If a thread is started using clone(2) with...</code> &#x5F00;&#x5934;&#x7684;&#xFF0C;&#x8FD9;&#x91CC;&#x7684; <code>clone</code> &#x662F; <code>sys_clone</code>&#xFF0C;&#x672C;&#x8D28;&#x4E0A;&#x548C;&#x6211;&#x4EEC;&#x7684; <code>sys_fork</code> &#x540C;&#x529F;&#x80FD;&#xFF0C;&#x4F46;&#x63D0;&#x4F9B;&#x66F4;&#x591A;&#x7684;&#x53C2;&#x6570;&#x3002;&#x56E0;&#x4E3A;&#x76EE;&#x524D;&#x5185;&#x6838;&#x91CC;&#x5BF9; <code>fork</code> &#x6CA1;&#x6709;&#x66F4;&#x591A;&#x7684;&#x53C2;&#x6570;&#x652F;&#x6301;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x663E;&#x7136;&#x4E0D;&#x4F1A;&#x6EE1;&#x8DB3;&#x8FD9;&#x91CC;&#x63D0;&#x5230;&#x7684; <code>If</code>&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x4E24;&#x4E2A;&#x60C5;&#x51B5;&#x76EE;&#x524D;&#x90FD;&#x662F;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#x3002;</p>
<p>&#x7531;&#x4E8E; <code>clear_child_tid</code> &#x5728;&#x76EE;&#x524D;&#x7684;&#x5185;&#x6838;&#x4E2D;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x6240;&#x4EE5;&#x4E0B;&#x4E00;&#x884C;&#x8BF4;&#x7684; <code>sets the clear_child_tid value for the calling thread to tidptr.</code> &#x7684;&#x60C5;&#x51B5;&#x4E5F;&#x53EF;&#x4EE5;&#x5FFD;&#x7565;&#xFF0C;&#x8FD9;&#x6837;&#x8FDE;&#x8FD9;&#x4E2A; <code>syscall</code> &#x7684;&#x552F;&#x4E00;&#x53C2;&#x6570; <code>tidptr</code> &#x4E5F;&#x53EF;&#x4EE5;&#x4E0D;&#x7528;&#x7BA1;&#xFF0C;&#x6211;&#x4EEC;&#x76F4;&#x63A5;&#x770B;&#x8FD4;&#x56DE;&#x503C;&#x5C31;&#x597D;&#x4E86;&#x3002;</p>
<blockquote>
<p>&#x9009;&#x62E9;&#x5FFD;&#x7565;&#x54EA;&#x4E9B;&#x63CF;&#x8FF0;&#x3001;&#x5B9E;&#x73B0;&#x54EA;&#x4E9B;&#x63CF;&#x8FF0;&#x5E76;&#x4E0D;&#x7B80;&#x5355;&#x3002;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x53EF;&#x4EE5;&#x8FD0;&#x884C;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x7A0B;&#x5E8F;&#xFF0C;&#x770B;&#x5B83;&#x5728;&#x8C03;&#x7528;&#x8FD9;&#x4E2A; <code>syscall</code> &#x7684;&#x65F6;&#x5019;&#x7ED9;&#x4E86;&#x54EA;&#x4E9B;&#x53C2;&#x6570;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x5185;&#x6838;&#x4E2D;&#x9009;&#x62E9;&#x6027;&#x5FFD;&#x7565;&#x5B83;&#x6CA1;&#x6709;&#x7ED9;&#x7684;&#x53C2;&#x6570;&#x3002;&#x4E0D;&#x8FC7;&#x6709;&#x65F6;&#x5019;&#x7528;&#x6237;&#x7A0B;&#x5E8F;&#x7ED9;&#x51FA;&#x7684;&#x53C2;&#x6570;&#x4E5F;&#x662F;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#xFF0C;&#x8FD9;&#x9700;&#x8981;&#x53CD;&#x590D; <code>debug</code> &#x624D;&#x80FD;&#x77E5;&#x9053;&#x3002;</p>
</blockquote>
<p>&#x8FD4;&#x56DE;&#x503C;&#x544A;&#x8BC9;&#x6211;&#x4EEC;&#xFF0C;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x8FD4;&#x56DE;&#x8C03;&#x7528;&#x8005;&#x7684;&#x7EBF;&#x7A0B; ID&#x3002;&#x8003;&#x8651; <code>rCore-Tutorial</code> &#x548C;&#x5B9E;&#x9645; <code>Linux</code> &#x7684;&#x7EBF;&#x7A0B;&#x5B9A;&#x4E49;&#x5DEE;&#x5F02;&#xFF08;<strong>&#x4E0B;&#x4E00;&#x8282;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;</strong>&#xFF09;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x6B64;&#x8FD4;&#x56DE; <code>pid</code>&#x3002;&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x5DF2;&#x6709;&#x7684; <code>sys_getpid()</code> &#x51FD;&#x6570;&#x5C31;&#x597D;&#x4E86;&#x3002;</p>
<p><strong>&#x6CE8;&#x610F;&#xFF0C;&#x8FD4;&#x56DE; <code>sys_getpid</code> &#x800C;&#x4E0D;&#x662F; <code>sys_gettid</code>&#xFF01;</strong></p>
<p><strong>&#x91CD;&#x590D;&#x4E00;&#x904D;&#xFF0C;&#x8FD4;&#x56DE; <code>sys_getpid</code> &#x800C;&#x4E0D;&#x662F; <code>sys_gettid</code>&#xFF01;</strong></p>
<p>&#x6211;&#x4EEC;&#x5728; <code>os/src/syscall/mod.rs</code> &#x6DFB;&#x52A0;&#x4E0A;&#x8FD9;&#x4E2A; <code>syscall</code>&#xFF1A;</p>
<pre><code class="lang-rust"><span class="hljs-comment">/// set_tid_address syscall</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">const</span> SYSCALL_SET_TID_ADDRESS: usize = <span class="hljs-number">96</span>;

<span class="hljs-comment">/// handle syscall exception with `syscall_id` and other arguments</span>
<span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">syscall</span></span>(syscall_id: usize, args: [usize; <span class="hljs-number">4</span>]) -&gt; isize {
    <span class="hljs-keyword">match</span> syscall_id {
        ......
        SYSCALL_SET_TID_ADDRESS =&gt; sys_getpid(),
        _ =&gt; <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;Unsupported syscall_id: {}&quot;</span>, syscall_id),
    }
}
</code></pre>
<p>&#x518D;&#x6B21;&#x8FD0;&#x884C;&#x7A0B;&#x5E8F;...&#x968F;&#x540E;&#x5B83;&#x5C31;&#x4F1A;&#x5361;&#x5728;&#x53E6;&#x4E00;&#x4E2A; <code>syscall</code> &#x4E0A;&#xFF1A;<code>Unsupported syscall_id: 29</code>&#x3002;</p>
<p>&#x4E0D;&#x8FC7;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F;&#x4F60;&#x7684;&#x4EFB;&#x52A1;&#x4E86;&#xFF1A;&#x770B;&#x770B;&#x5E03;&#x7F6E;&#x5B9E;&#x9A8C;&#x90A3;&#x4E00;&#x8282;&#x7684;&#x8981;&#x6C42;&#xFF0C;&#x8865;&#x4E0A;&#x7F3A;&#x5931;&#x7684; <code>syscall</code> &#x4F7F;&#x5F97; <code>hellostd</code> &#x6D4B;&#x4F8B;&#x8FD0;&#x884C;&#x6210;&#x529F;&#x3002;</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="gdb.html" class="navigation navigation-prev " aria-label="Previous page: GDB 调试">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="tid.html" class="navigation navigation-next " aria-label="Next page: 规范：TID 定义问题">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"通过 Manual Page 添加 Syscall","level":"3.5","depth":1,"next":{"title":"规范：TID 定义问题","level":"3.6","depth":1,"path":"docs/lab2/tid.md","ref":"docs/lab2/tid.md","articles":[]},"previous":{"title":"GDB 调试","level":"3.4","depth":1,"path":"docs/lab2/gdb.md","ref":"docs/lab2/gdb.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["hide-element","chapter-fold","katex","alerts","emphasize","mermaid-gb3","codeblock-label","code","search-pro","click-reveal","expandable-chapters-interactive","localized-footer","intopic-toc"],"pluginsConfig":{"chapter-fold":{},"emphasize":{},"intopic-toc":{"isCollapsed":true,"isScrollspyActive":true,"label":"In this article","maxDepth":6,"mode":"nested","selector":".markdown-section h1, .markdown-section h2, .markdown-section h3, .markdown-section h4, .markdown-section h5, .markdown-section h6","visible":true},"codeblock-label":{},"search-pro":{},"search":{},"localized-footer":{"filename":"gitalk.html","hline":"true"},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"code":{"copyButtons":true},"hide-element":{},"katex":{},"fontsettings":{"theme":"white","family":"sans","size":1},"click-reveal":{},"highlight":{},"mermaid-gb3":{},"expandable-chapters-interactive":{},"alerts":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"docs/lab2/syscall.md","mtime":"2023-11-22T09:49:43.637Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2023-11-22T09:50:29.361Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-hide-element/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-alerts/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-mermaid-gb3/book/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-click-reveal/click_reveal.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-expandable-chapters-interactive/expandable-chapters.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-intopic-toc/anchor.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-intopic-toc/gumshoe.polyfills.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-intopic-toc/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    <script src="../../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.min.js"></script>

    </body>
</html>

